digraph {
  ranksep="0.025"
  nodesep="0.7"
  node[fontname="Sans", style="rounded,filled,bold" shape=rectangle, fillcolor="#ffffff", margin="0.1,0.1"]
  edge[fontname="Sans",fontsize="8"]

  node[shape=rectangle,fontsize=16]
  edge[fontsize=14]

  { dmr, task_dmr2imgs, dmr_imgs, l1_task_seg; rank=same }

  dmr [
    label="DMR Visual Lab\n[Pacientes,\nVisitas,\nDiagnóstico]",
    shape=cylinder, fillcolor="#dddddd"
  ]

  task_dmr2imgs [label="Normalização,\nConversão\nde termogramas\nem imagens"]

  dmr_imgs [
    label="Imagens\nRegião do Torax"
    shape=cylinder, fillcolor="#dddddd"
  ]

  dmr -> task_dmr2imgs -> dmr_imgs

  l1_task_seg [label="Segmentação do Fundo,\nAnálise de Momento\n(Simetria Bilateral)"]
  dmr_imgs -> l1_task_seg
  l1_task_seg -> l2_imgs
  dmr -> l2_imgs [style=invis]

  l2_imgs[
    label="Imagens segmentadas\nde cada lado\n[Direto/Esquerdo]", 
    shape=cylinder, fillcolor="#dddddd"
]
  l2_imgs -> l2_task_extracao_features

  subgraph cluster_l2 {
    rankdir=LR
    fontsize=16
    fontname="Sans"
    label="L2: cada lado do torax"

    l2_task_extracao_features[label="Extração de features\nde cada lado,\nCálculo de diferenças\nentre lados"]
    l2_task_extracao_features -> l2_data

    l2_data[
      label="H: Features Haralick\ndh: Diferenças de H\nB: Feature LBP\ndb: Diferenças em B",
      shape=cylinder, fillcolor="#dddddd"
    ]

    subgraph cluster_l2_seed {
    fontname="Sans"
    label="(multiplas iterações)"
    fontsize="12"
    style="dashed"
    l2_pre_classificador [label="Particionamento", shape=rectangle, style=rounded]

    subgraph cluster_l2_seed_tto {
    fontname="Sans"
    label="(para cada base [H, B, H+B])"
    fontsize="12"
    style="dashed"
    l2_pre_classificador_2 [label="Tratamentos\n(base, base+dh,\nbase+db, base+dh+db)", shape=rectangle, style=rounded]

    subgraph cluster_l2_seed_class {
    fontname="Sans"
    label="(para cada Classificador)"
    fontsize="12"
    style="dashed"
    l2_classificador [label="Treinamento\nClassificação", shape=rectangle, style=rounded]

    l2_seed_results [
      label="Resultados da Iteração\nMétricas da Classificação", 
      shape=cylinder, fillcolor="#dddddd"
    ]

    }

    }


    }
    l2_results [
      label="Resultados L2\nMétricas da Classificação\n(Médias e Desvio Padrão)",
      shape=cylinder, fillcolor="#dddddd"
    ]

    l2_data -> l2_pre_classificador -> l2_pre_classificador_2 -> l2_classificador -> l2_seed_results -> l2_results

  }


  final_results[
      label="Resultado Final",
      shape=cylinder, fillcolor="#dddddd"
  ]

  subgraph cluster_final {
    fontname="Sans"
    label="Testes Post-Hoc\npara cada [Nível, Base])"
    fontsize="16"
    style="dashed"
    { final_friedman, final_nemenyi; rank = same}
    l2_results -> final_friedman 
    final_friedman -> final_nemenyi [label="sim\lp < 0.05\l"]

    final_friedman[label="Friedman Chi^2\nPosso rejeitar\nHipótese nula?"]
    final_nemenyi[label="Friedman-Nemenyi\n(pares com diferenças\nsignificativas)"]
  }

    final_friedman -> final_results [label="não,\lp > 0.05\l"]
    final_nemenyi -> final_results

  l3_task_segmentacao[label="** Etapa Manual **\nSegmentação de\nquadrantes das mamas"]
  l3_imgs_masks[
      label="Máscaras para\ncada quadrante: \n[Esquerdo/Direito,\nInferior/Superior\nInterno/Externo]",
      shape=cylinder, fillcolor="#dddddd"
  ]

  // tweak layout
  l1_task_seg -> l3_imgs_masks [style=invis]

  l3_task_aplicao_masks_mama_inteira[label="Montagem e aplicação\nde máscaras de\nmama inteira"]
  l3_task_aplicao_masks_quads[label="Aplicação de máscaras\nde cada quadrante\nde cada mama"]

  l3_imgs[
      label="Imagens segmentadas\nde cada mama: \n[Esquerda/Direita]",
      shape=cylinder, fillcolor="#dddddd"
  ]

  l4_imgs[
      label="Imagens segmentadas\nde cada quadrante: \n[Esquerdo/Direito,\nInferior/Superior\nInterno/Externo]",
      shape=cylinder, fillcolor="#dddddd"
  ]

  l3_imgs_masks -> l3_task_aplicao_masks_mama_inteira -> l3_imgs
  l2_imgs -> l3_task_aplicao_masks_mama_inteira

  l2_imgs -> l3_task_segmentacao
  l3_task_segmentacao -> l3_imgs_masks

  { l2_imgs, l3_task_segmentacao, l3_imgs_masks; rank=same}

  { l3_imgs, l4_imgs; rank=same}


  l3_imgs_masks -> l3_task_aplicao_masks_quads -> l4_imgs
  l2_imgs -> l3_task_aplicao_masks_quads


  subgraph cluster_l3 {
    rankdir=LR
    fontsize=16
    fontname="Sans"
    label="L3: cada mama"

    l3_task_extracao_features[label="Extração de features\nde cada mama,\nCálculo de diferenças\nentre mamas"]
    l3_dotdotdot[style="", label="...\n(similar à L2)", shape=none]
    l3_results [
      label="Resultados L3\nMétricas de Performance\n(Médias e Desvio Padrão)",
      shape=cylinder, fillcolor="#dddddd"
    ]
  }

  subgraph cluster_l4 {
    rankdir=LR
    fontsize=16
    fontname="Sans"
    label="L4: cada quadrante\nde cada mama"

    l4_task_extracao_features[label="Extração de features\nde cada quadrante,\nCálculo de diferenças\nentre quadrantes\ncorrespondentes"]
    l4_dotdotdot[style="", label="...\n(similar à L2)", shape=none]
    l4_results [
      label="Resultados L4\nMétricas de Performance\n(Médias e Desvio Padrão)",
      shape=cylinder, fillcolor="#dddddd"
    ]
  }

    l3_imgs -> l3_task_extracao_features -> l3_dotdotdot -> l3_results -> final_friedman
    l4_imgs -> l4_task_extracao_features -> l4_dotdotdot -> l4_results -> final_friedman

}
